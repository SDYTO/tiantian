#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os
import sys
import json
import requests
from datetime import datetime
import argparse

# å…¨å±€é…ç½®
BLOG_BASE_FILE = "blogBase.json"
DOCS_DIR = "docs"
BACKUP_DIR = "backup"
ISSUE_CONTENT_KEY = "content"
PER_PAGE = 2  # æ¯é¡µæ˜¾ç¤ºçš„æ–‡ç« æ•°é‡

def init_dirs():
    """åˆå§‹åŒ–å¿…è¦ç›®å½•ï¼ˆdocs/backupï¼‰"""
    for dir_name in [DOCS_DIR, BACKUP_DIR]:
        if not os.path.exists(dir_name):
            os.makedirs(dir_name)
            print(f"âœ… åˆ›å»ºç›®å½•ï¼š{dir_name}")

def load_blog_base():
    """åŠ è½½åšå®¢åŸºç¡€é…ç½®ï¼ˆblogBase.jsonï¼‰ï¼Œç¡®ä¿ posts å­—æ®µå­˜åœ¨"""
    if os.path.exists(BLOG_BASE_FILE):
        try:
            with open(BLOG_BASE_FILE, "r", encoding="utf-8") as f:
                blog_base = json.load(f)
            # æ£€æŸ¥å¹¶è¡¥å……ç¼ºå¤±çš„å­—æ®µ
            if "posts" not in blog_base:
                blog_base["posts"] = []
                print("âš ï¸ ä¿®å¤é…ç½®æ–‡ä»¶ï¼šæ·»åŠ ç¼ºå¤±çš„ posts å­—æ®µ")
            if "title" not in blog_base:
                blog_base["title"] = "My Gmeek Blog"
            if "subtitle" not in blog_base:
                blog_base["subtitle"] = "Auto-generated by Gmeek"
            if "author" not in blog_base:
                blog_base["author"] = os.getenv("GITHUB_REPOSITORY_OWNER", "Anonymous")
            if "last_update" not in blog_base:
                blog_base["last_update"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            # ä¿å­˜ä¿®å¤åçš„é…ç½®
            with open(BLOG_BASE_FILE, "w", encoding="utf-8") as f:
                json.dump(blog_base, f, ensure_ascii=False, indent=2)
            return blog_base
        except Exception as e:
            print(f"âš ï¸ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œé‡æ–°ç”Ÿæˆé»˜è®¤é…ç½®ï¼š{str(e)}")
            os.remove(BLOG_BASE_FILE)  # åˆ é™¤æŸåçš„æ–‡ä»¶

    # ç”Ÿæˆå…¨æ–°çš„é»˜è®¤é…ç½®
    default_base = {
        "title": "My Gmeek Blog",
        "subtitle": "Auto-generated by Gmeek",
        "author": os.getenv("GITHUB_REPOSITORY_OWNER", "Anonymous"),
        "last_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "posts": []  # å¿…å«å­—æ®µï¼Œå­˜å‚¨æ–‡ç« åˆ—è¡¨
    }
    with open(BLOG_BASE_FILE, "w", encoding="utf-8") as f:
        json.dump(default_base, f, ensure_ascii=False, indent=2)
    print(f"âœ… ç”Ÿæˆå…¨æ–°é»˜è®¤é…ç½®æ–‡ä»¶ï¼š{BLOG_BASE_FILE}")
    return default_base

def fetch_issue_content(github_token, repo, issue_number):
    """ä» GitHub Issue è·å–å†…å®¹ï¼ˆå¦‚æœæŒ‡å®šäº† issue_numberï¼‰"""
    if not issue_number or issue_number == "":
        print("â„¹ï¸ æœªæŒ‡å®š Issue ç¼–å·ï¼Œè·³è¿‡è·å– Issue å†…å®¹")
        return None
    
    url = f"https://api.github.com/repos/{repo}/issues/{issue_number}"
    headers = {
        "Authorization": f"token {github_token}",
        "Accept": "application/vnd.github.v3+json"
    }
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        issue = response.json()
        # è¿”å› Issue çš„æ ‡é¢˜å’Œå†…å®¹ï¼ˆä¿ç•™åŸå§‹Markdownæ ¼å¼ï¼‰
        return {
            "title": issue["title"],
            "content": issue["body"],  # ä¸å†æ›¿æ¢æ¢è¡Œç¬¦ï¼Œä¿ç•™åŸå§‹Markdown
            "created_at": issue["created_at"],
            "updated_at": issue["updated_at"]
        }
    except Exception as e:
        print(f"âš ï¸ è·å– Issue å†…å®¹å¤±è´¥ï¼š{str(e)}")
        return None

def generate_pagination_data(posts, current_page):
    """ç”Ÿæˆåˆ†é¡µæ•°æ®"""
    total_posts = len(posts)
    total_pages = max(1, (total_posts + PER_PAGE - 1) // PER_PAGE)  # æ€»é¡µæ•°
    
    # ç¡®ä¿å½“å‰é¡µåœ¨æœ‰æ•ˆèŒƒå›´å†…
    current_page = max(1, min(current_page, total_pages))
    
    # è®¡ç®—å½“å‰é¡µæ˜¾ç¤ºçš„æ–‡ç« 
    start = (current_page - 1) * PER_PAGE
    end = start + PER_PAGE
    current_posts = posts[start:end]
    
    # è®¡ç®—ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µçš„URL
    prev_url = f"index_{current_page - 1}.html" if current_page > 1 else None
    next_url = f"index_{current_page + 1}.html" if current_page < total_pages else None
    
    return {
        "current_page": current_page,
        "total_pages": total_pages,
        "prev_url": prev_url,
        "next_url": next_url,
        "current_posts": current_posts
    }

def generate_html(blog_base, issue_content=None):
    """ç”Ÿæˆå¸¦åˆ†é¡µå’ŒMarkdownæ”¯æŒçš„HTMLåšå®¢é¡µé¢"""
    # 1. æ›´æ–°åšå®¢åŸºç¡€ä¿¡æ¯
    blog_base["last_update"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # 2. å¦‚æœæœ‰Issueå†…å®¹ï¼Œæ·»åŠ ä¸ºæ–°æ–‡ç« 
    if issue_content and isinstance(blog_base["posts"], list):
        new_post = {
            "id": len(blog_base["posts"]) + 1,
            "title": issue_content["title"],
            "content": issue_content["content"],  # ä¿ç•™åŸå§‹Markdownå†…å®¹
            "created_at": issue_content["created_at"].split("T")[0],
            "updated_at": issue_content["updated_at"].split("T")[0]
        }
        blog_base["posts"].append(new_post)
        # ä¿å­˜æ›´æ–°åçš„blogBase.json
        with open(BLOG_BASE_FILE, "w", encoding="utf-8") as f:
            json.dump(blog_base, f, ensure_ascii=False, indent=2)
        print(f"âœ… æ–°å¢æ–‡ç« ï¼š{issue_content['title']}")
    
    # å‡†å¤‡æ–‡ç« åˆ—è¡¨ï¼ˆå€’åºï¼Œæœ€æ–°çš„åœ¨å‰ï¼‰
    posts = list(reversed(blog_base["posts"]))
    total_pages = max(1, (len(posts) + PER_PAGE - 1) // PER_PAGE)
    
    # 3. ç”Ÿæˆæ‰€æœ‰åˆ†é¡µé¡µé¢ï¼ˆåŒ…å«Markdownè§£ææ”¯æŒï¼‰
    html_template = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <!-- å¼•å…¥Markdownè§£æåº“å’Œä»£ç é«˜äº®åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <style>
        body {{ max-width: 1200px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }}
        .header {{ text-align: center; margin-bottom: 50px; }}
        .post {{ margin: 30px 0; padding: 20px; border-bottom: 1px solid #eee; }}
        .post-title {{ color: #2c3e50; margin-bottom: 10px; }}
        .post-meta {{ color: #7f8c8d; font-size: 0.9em; margin-bottom: 15px; }}
        .post-content {{ line-height: 1.6; color: #34495e; }}
        .footer {{ text-align: center; margin-top: 50px; color: #7f8c8d; }}
        .no-posts {{ text-align: center; padding: 50px; color: #7f8c8d; }}
        .pagination {{ text-align: center; margin: 30px 0; }}
        .pagination a {{ 
            display: inline-block; 
            margin: 0 5px; 
            padding: 8px 16px; 
            text-decoration: none; 
            border: 1px solid #ddd; 
            color: #333;
            border-radius: 4px;
        }}
        .pagination a.active {{ 
            background-color: #4CAF50; 
            color: white; 
            border: 1px solid #4CAF50;
        }}
        .pagination a:hover:not(.active) {{ background-color: #ddd; }}
        .pagination a.disabled {{
            opacity: 0.5;
            pointer-events: none;
            background-color: #f1f1f1;
        }}
        /* Markdownæ ·å¼å¢å¼º */
        .post-content h1 {{ font-size: 1.8em; margin: 1.5em 0 1em; }}
        .post-content h2 {{ font-size: 1.5em; margin: 1.2em 0 0.8em; }}
        .post-content h3 {{ font-size: 1.2em; margin: 1em 0 0.6em; }}
        .post-content ul, .post-content ol {{ margin: 1em 0; padding-left: 2em; }}
        .post-content li {{ margin: 0.5em 0; }}
        .post-content p {{ margin: 1em 0; }}
        .post-content blockquote {{ 
            border-left: 4px solid #ddd; 
            padding-left: 1em; 
            margin: 1em 0; 
            color: #666;
        }}
        .post-content code {{ 
            background: #f5f5f5; 
            padding: 0.2em 0.4em; 
            border-radius: 4px;
            font-family: monospace;
        }}
        .post-content pre {{ 
            background: #f5f5f5; 
            padding: 1em; 
            border-radius: 4px;
            overflow-x: auto;
            margin: 1em 0;
        }}
        .post-content pre code {{ 
            padding: 0;
            background: none;
        }}
        .post-content a {{ color: #2c3e50; text-decoration: underline; }}
        .post-content img {{ max-width: 100%; margin: 1em 0; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>{title}</h1>
        <p>{subtitle}</p>
        <p>ä½œè€…ï¼š{author} | æœ€åæ›´æ–°ï¼š{last_update}</p>
    </div>

    <div class="posts">
        {posts_html}
    </div>

    <div class="pagination">
        {pagination_html}
    </div>

    <div class="footer">
        <p>æ•°å­—çš„ä¸–ç•Œ | <a href="https://ruihan.xin" target="_blank">æ•°å­—æ£®æ—</a></p>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè§£ææ‰€æœ‰Markdownå†…å®¹
        document.addEventListener('DOMContentLoaded', function() {{
            // è§£ææ–‡ç« å†…å®¹
            document.querySelectorAll('.post-content').forEach(function(element) {{
                const markdown = element.textContent;
                const html = marked.parse(markdown);
                element.innerHTML = html;
            }});
            
            // ä»£ç é«˜äº®å¤„ç†
            document.querySelectorAll('pre code').forEach(function(block) {{
                hljs.highlightElement(block);
            }});
        }});
    </script>
</body>
</html>
    """
    
    # ä¸ºæ¯ä¸€é¡µç”ŸæˆHTML
    for page in range(1, total_pages + 1):
        pagination = generate_pagination_data(posts, page)
        
        # ç”Ÿæˆæ–‡ç« åˆ—è¡¨HTMLï¼ˆä¿ç•™åŸå§‹Markdownå†…å®¹ç”¨äºå‰ç«¯è§£æï¼‰
        if pagination["current_posts"]:
            posts_html = ""
            for post in pagination["current_posts"]:
                posts_html += f"""
                <div class="post">
                    <h2 class="post-title">{post['title']}</h2>
                    <div class="post-meta">åˆ›å»ºæ—¶é—´ï¼š{post['created_at']} | æ›´æ–°æ—¶é—´ï¼š{post['updated_at']}</div>
                    <div class="post-content">{post['content']}</div>
                </div>
                """
        else:
            posts_html = '<div class="no-posts">æš‚æ— æ–‡ç« ï¼Œå¿«å»åˆ›å»º Issue ç”Ÿæˆç¬¬ä¸€ç¯‡åšå®¢å§ï¼</div>'
        
        # ç”Ÿæˆåˆ†é¡µæŒ‰é’®HTML
        pagination_html = []
        # ä¸Šä¸€é¡µ
        if pagination["prev_url"]:
            pagination_html.append(f'<a href="{pagination["prev_url"]}">ä¸Šä¸€é¡µ</a>')
        else:
            pagination_html.append('<a class="disabled">ä¸Šä¸€é¡µ</a>')
        
        # é¡µç 
        for i in range(1, total_pages + 1):
            if i == pagination["current_page"]:
                pagination_html.append(f'<a href="index_{i}.html" class="active">{i}</a>')
            else:
                pagination_html.append(f'<a href="index_{i}.html">{i}</a>')
        
        # ä¸‹ä¸€é¡µ
        if pagination["next_url"]:
            pagination_html.append(f'<a href="{pagination["next_url"]}">ä¸‹ä¸€é¡µ</a>')
        else:
            pagination_html.append('<a class="disabled">ä¸‹ä¸€é¡µ</a>')
        
        pagination_html = "".join(pagination_html)
        
        # å¡«å……æ¨¡æ¿
        index_html = html_template.format(
            title=blog_base["title"],
            subtitle=blog_base["subtitle"],
            author=blog_base["author"],
            last_update=blog_base["last_update"],
            posts_html=posts_html,
            pagination_html=pagination_html
        )
        
        # ä¿å­˜é¡µé¢ï¼ˆé¦–é¡µåŒæ—¶ä¿å­˜ä¸ºindex.htmlæ–¹ä¾¿è®¿é—®ï¼‰
        if page == 1:
            index_paths = [
                os.path.join(DOCS_DIR, "index.html"),
                os.path.join(DOCS_DIR, f"index_{page}.html")
            ]
        else:
            index_paths = [os.path.join(DOCS_DIR, f"index_{page}.html")]
        
        for path in index_paths:
            with open(path, "w", encoding="utf-8") as f:
                f.write(index_html)
            print(f"âœ… ç”Ÿæˆé¡µé¢ï¼š{path}")

def backup_blog_base():
    """å¤‡ä»½ blogBase.json åˆ° backup ç›®å½•"""
    if os.path.exists(BLOG_BASE_FILE):
        backup_path = os.path.join(BACKUP_DIR, f"blogBase_{datetime.now().strftime('%Y%m%d%H%M%S')}.json")
        with open(BLOG_BASE_FILE, "r", encoding="utf-8") as f_in, open(backup_path, "w", encoding="utf-8") as f_out:
            json.dump(json.load(f_in), f_out, ensure_ascii=False, indent=2)
        print(f"âœ… å¤‡ä»½é…ç½®æ–‡ä»¶ï¼š{backup_path}")

def main():
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = argparse.ArgumentParser(description="Gmeek Blog Generator")
    parser.add_argument("github_token", help="GitHub Token for API access")
    parser.add_argument("repo", help="GitHub Repository (owner/repo)")
    parser.add_argument("--issue_number", help="GitHub Issue Number to fetch content", default="")
    args = parser.parse_args()
    
    try:
        print("ğŸš€ å¼€å§‹æ‰§è¡Œ Gmeek åšå®¢ç”Ÿæˆæµç¨‹...")
        # 1. åˆå§‹åŒ–ç›®å½•
        init_dirs()
        # 2. åŠ è½½åšå®¢åŸºç¡€é…ç½®
        blog_base = load_blog_base()
        # 3. ï¼ˆå¯é€‰ï¼‰ä»Issueè·å–å†…å®¹
        issue_content = fetch_issue_content(args.github_token, args.repo, args.issue_number)
        # 4. ç”ŸæˆHTMLé¡µé¢ï¼ˆå¸¦åˆ†é¡µå’ŒMarkdownæ”¯æŒï¼‰
        generate_html(blog_base, issue_content)
        # 5. å¤‡ä»½é…ç½®æ–‡ä»¶
        backup_blog_base()
        print("ğŸ‰ Gmeek åšå®¢ç”Ÿæˆæµç¨‹æ‰§è¡Œå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()
