name: build Gmeek

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  issues:
    types: [opened, edited]  # Issue è§¦å‘
  schedule:
    - cron: "0 16 * * *"  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤© UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00ï¼‰
    
jobs:
  build:
    name: Generate blog
    runs-on: ubuntu-24.04
    # æƒé™æ§åˆ¶ï¼šä»“åº“æ‰€æœ‰è€…æˆ–å®šæ—¶ä»»åŠ¡å¯è§¦å‘
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule' }}
    permissions: write-all  # ä¿ç•™åŸæœ‰å…¨å†™æƒé™ï¼ˆé€‚é…ä»£ç æäº¤ã€æ–‡ä»¶æ“ä½œï¼‰
    steps:
      - name: Checkout æœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Setup Pages é…ç½®
        id: pages
        uses: actions/configure-pages@v4  # é€‚é… GitHub Pages éƒ¨ç½²

      - name: å®‰è£…ä¾èµ–å·¥å…·ï¼ˆjq + Python ä¾èµ–ï¼‰
        run: |
          # å®‰è£… jqï¼ˆç”¨äºè§£æ config.jsonï¼‰
          sudo apt-get update && sudo apt-get install -y jq
          echo "====== æ£€æŸ¥ config.json æ–‡ä»¶ ======"
          if [ -f "config.json" ]; then
            cat config.json
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° config.json æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ä»“åº“ä¸­å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶ï¼"
            exit 1
          fi
          echo "====== æ£€æŸ¥ config.json ç»“æŸ ======"

      - name: é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.8  # ä¿æŒåŸæœ‰ Python ç‰ˆæœ¬ï¼ˆé€‚é… Gmeek ä¾èµ–ï¼‰
          cache: "pip"  # ç¼“å­˜ pip ä¾èµ–ï¼ŒåŠ å¿«å®‰è£…é€Ÿåº¦

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          # å®‰è£…æœ¬ä»“åº“æ ¹ç›®å½•çš„ requirements.txt ä¾èµ–ï¼ˆè€Œéå¤–éƒ¨ä»“åº“ï¼‰
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° requirements.txt æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ä»“åº“ä¸­å­˜åœ¨è¯¥ä¾èµ–æ–‡ä»¶ï¼"
            exit 1
          fi

      - name: ç”Ÿæˆåšå®¢ HTML æ–‡ä»¶
        run: |
          echo "====== å¼€å§‹æ‰§è¡Œ Gmeek ç”Ÿæˆè„šæœ¬ ======"
          # ç›´æ¥åœ¨æœ¬ä»“åº“æ ¹ç›®å½•æ‰§è¡Œ Gmeek.pyï¼ˆæ— éœ€å¤åˆ¶æ–‡ä»¶åˆ°å¤–éƒ¨ç›®å½•ï¼‰
          if [ -f "Gmeek.py" ]; then
            python Gmeek.py \
              ${{ secrets.GITHUB_TOKEN }} \  # GitHub å†…ç½®ä»¤ç‰Œï¼ˆç”¨äºä»“åº“æ“ä½œï¼‰
              ${{ github.repository }} \     # å½“å‰ä»“åº“åœ°å€ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰
              --issue_number '${{ github.event.issue.number || '' }}'  # Issue ç¼–å·ï¼ˆæ— åˆ™ä¸ºç©ºï¼‰
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Gmeek.py ä¸»è„šæœ¬ï¼Œè¯·ç¡®è®¤ä»“åº“ä¸­å­˜åœ¨è¯¥æ–‡ä»¶ï¼"
            exit 1
          fi

          # éªŒè¯ç”Ÿæˆç»“æœï¼ˆç¡®ä¿ docs ç›®å½•å­˜åœ¨ï¼Œå¦åˆ™éƒ¨ç½²ä¼šå¤±è´¥ï¼‰
          echo "====== éªŒè¯ç”Ÿæˆäº§ç‰© ======"
          if [ -d "docs" ]; then
            echo "docs ç›®å½•ç”ŸæˆæˆåŠŸï¼Œç›®å½•ç»“æ„ï¼š"
            ls -la docs/
          else
            echo "é”™è¯¯ï¼šGmeek è„šæœ¬æœªç”Ÿæˆ docs ç›®å½•ï¼Œè¯·æ£€æŸ¥è„šæœ¬æ‰§è¡Œæ—¥å¿—ï¼"
            exit 1
          fi

      - name: æäº¤ç”Ÿæˆçš„æ–‡ä»¶åˆ°æœ¬ä»“åº“
        run: |
          # é…ç½® Git æäº¤è€…ä¿¡æ¯ï¼ˆä» config.json è¯»å–é‚®ç®±ï¼Œä»“åº“æ‰€æœ‰è€…ä½œä¸ºç”¨æˆ·åï¼‰
          git config --local user.name "${{ github.repository_owner }}"
          git config --local user.email "$(jq -r ".email" config.json)"

          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆdocs ç›®å½•ã€backup ç›®å½•ã€blogBase.jsonï¼‰
          git add docs/ backup/ blogBase.json 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡"
          # æäº¤å˜æ›´ï¼ˆæ— å˜æ›´åˆ™ä¸æŠ¥é”™ï¼‰
          git commit -m 'ğŸ‰auto update by Gmeek action (${{ github.sha }})' || echo "æ— æ–°å†…å®¹éœ€è¦æäº¤"
          # æ¨é€åˆ°å½“å‰ä»“åº“çš„å½“å‰åˆ†æ”¯ï¼ˆè€Œéå¤–éƒ¨åˆ†æ”¯ï¼‰
          git push origin ${{ github.ref }} || echo "æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æƒé™æˆ–æ— å˜æ›´ï¼‰"
          sleep 3  # ç­‰å¾…æ¨é€å®Œæˆï¼Œé¿å…åç»­æ­¥éª¤å†²çª

      - name: ä¸Šä¼  Pages éƒ¨ç½²äº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/.'  # ä¸Šä¼  docs ç›®å½•ï¼ˆGitHub Pages éƒ¨ç½²çš„æ ¸å¿ƒäº§ç‰©ï¼‰
          
  deploy:
    name: Deploy blog to GitHub Pages
    runs-on: ubuntu-24.04
    needs: build  # ä¾èµ– build ä»»åŠ¡å®Œæˆ
    permissions:
      contents: write
      pages: write
      id-token: write  # GitHub Pages éƒ¨ç½²å¿…éœ€çš„èº«ä»½éªŒè¯æƒé™
    concurrency:
      group: "pages"  # é¿å…å¹¶è¡Œéƒ¨ç½²å†²çª
      cancel-in-progress: false
    environment:
      name: github-pages  # å›ºå®šç¯å¢ƒåç§°ï¼ˆGitHub Pages è¦æ±‚ï¼‰
      url: ${{ steps.deployment.outputs.page_url }}  # è¾“å‡ºéƒ¨ç½²åçš„è®¿é—®åœ°å€
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # å®˜æ–¹éƒ¨ç½² Actionï¼ˆé€‚é… GitHub Actions æ„å»ºæ¥æºï¼‰
