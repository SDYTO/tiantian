name: build Gmeek

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  issues:
    types: [opened, edited]  # Issue è§¦å‘ï¼ˆæ–°å»º/ç¼–è¾‘ Issue æ—¶è‡ªåŠ¨ç”Ÿæˆåšå®¢ï¼‰
  schedule:
    - cron: "0 16 * * *"  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤© UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00ï¼‰
    
jobs:
  build:
    name: Generate blog
    runs-on: ubuntu-24.04
    # æƒé™æ§åˆ¶ï¼šä»“åº“æ‰€æœ‰è€…æˆ–å®šæ—¶ä»»åŠ¡å¯è§¦å‘
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule' }}
    permissions: write-all  # å…¨å†™æƒé™ï¼ˆé€‚é…æäº¤ä»£ç ã€åˆ›å»ºç›®å½•ï¼‰
    steps:
      - name: Checkout æœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Setup Pages é…ç½®
        id: pages
        uses: actions/configure-pages@v4  # é€‚é… GitHub Pages

      - name: å®‰è£…ä¾èµ–å·¥å…·ï¼ˆjqï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "====== æ£€æŸ¥ config.json æ–‡ä»¶ ======"
          if [ -f "config.json" ]; then
            cat config.json
          else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° config.json æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ä»“åº“æ ¹ç›®å½•å­˜åœ¨è¯¥æ–‡ä»¶ï¼"
            exit 1
          fi
          echo "====== æ£€æŸ¥ config.json ç»“æŸ ======"

      - name: é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.8  # å…¼å®¹ Gmeek.py çš„ Python ç‰ˆæœ¬

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          # å®‰è£…ä¾èµ–ï¼ˆä¼˜å…ˆè¯»å– requirements.txtï¼Œæ— åˆ™ç›´æ¥å®‰è£… requestsï¼‰
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install requests
          fi

      - name: ç”Ÿæˆåšå®¢ HTML æ–‡ä»¶
        run: |
          echo "====== å¼€å§‹æ‰§è¡Œ Gmeek ç”Ÿæˆè„šæœ¬ ======"
          # éªŒè¯ Gmeek.py æ˜¯å¦å­˜åœ¨
          if [ ! -f "Gmeek.py" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° Gmeek.py ä¸»è„šæœ¬ï¼Œè¯·ç¡®è®¤ä»“åº“æ ¹ç›®å½•å­˜åœ¨è¯¥æ–‡ä»¶ï¼"
            exit 1
          fi
          # æ‰§è¡Œ Gmeek.pyï¼ˆä¼ é€’ Tokenã€ä»“åº“åœ°å€ã€Issue ç¼–å·ï¼‰
          python Gmeek.py \
            ${{ secrets.GITHUB_TOKEN }} \
            ${{ github.repository }} \
            --issue_number '${{ github.event.issue.number || '' }}'
          echo "====== Gmeek è„šæœ¬æ‰§è¡Œå®Œæˆ ======"

          # éªŒè¯ç”Ÿæˆç»“æœï¼ˆç¡®ä¿ docs/index.html å­˜åœ¨ï¼‰
          echo "====== éªŒè¯ç”Ÿæˆäº§ç‰© ======"
          if [ -f "docs/index.html" ]; then
            echo "âœ… docs/index.html ç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$(du -sh docs/index.html | awk '{print $1}')"
            # å¯é€‰ï¼šæ‰“å°å‰ 5 è¡Œ HTML ç¡®è®¤ç»“æ„
            echo "====== é¦–é¡µ HTML å‰ 5 è¡Œ ======"
            head -n 5 docs/index.html
          else
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆ docs/index.htmlï¼Œè¯·æ£€æŸ¥ Gmeek.py æ‰§è¡Œæ—¥å¿—ï¼"
            exit 1
          fi

      - name: æäº¤ç”Ÿæˆçš„æ–‡ä»¶åˆ°æœ¬ä»“åº“
        run: |
          # é…ç½® Git æäº¤è€…ä¿¡æ¯
          git config --local user.name "${{ github.repository_owner }}"
          git config --local user.email "$(jq -r ".email" config.json)"

          # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶ï¼ˆdocs ç›®å½•ã€backup ç›®å½•ã€blogBase.jsonï¼‰
          git add docs/ backup/ blogBase.json 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡"
          # æäº¤ï¼ˆæ— å˜æ›´åˆ™ä¸æŠ¥é”™ï¼‰
          git commit -m 'ğŸ‰auto update by Gmeek action (${{ github.sha }})' || echo "â„¹ï¸ æ— æ–°å†…å®¹éœ€è¦æäº¤"
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          git push origin ${{ github.ref }} || echo "â„¹ï¸ æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æƒé™æˆ–æ— å˜æ›´ï¼‰"
          sleep 3

      - name: ä¸Šä¼  Pages éƒ¨ç½²äº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/.'  # ä¸Šä¼  docs ç›®å½•ï¼ˆåŒ…å« index.htmlï¼‰
          
  deploy:
    name: Deploy blog to GitHub Pages
    runs-on: ubuntu-24.04
    needs: build  # ä¾èµ– build ä»»åŠ¡å®Œæˆ
    permissions:
      contents: write
      pages: write
      id-token: write  # GitHub Pages éƒ¨ç½²å¿…éœ€æƒé™
    concurrency:
      group: "pages"
      cancel-in-progress: false
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
